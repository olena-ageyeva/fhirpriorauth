<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR and Availity API Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            border-left: 5px solid #4CAF50;
        }
        .error {
            border-left: 5px solid #f44336;
        }
        .info {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #loading {
            display: none;
            margin-left: 10px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 15px;
            color: #4CAF50;
            text-decoration: none;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .json-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .json-editor {
            width: 100%;
            height: 600px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: none;
            box-sizing: border-box;
        }
        .json-viewer {
            width: 100%;
            height: 600px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: auto;
            background-color: #f9f9f9;
            box-sizing: border-box;
        }
        .button-container {
            display: flex;
            gap: 10px;
        }
        .edit-button {
            background-color: #2196F3;
        }
        .edit-button:hover {
            background-color: #0b7dda;
        }
        .convert-button {
            background-color: #FF9800;
            font-weight: bold;
        }
        .convert-button:hover {
            background-color: #e68a00;
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success-message {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="/auth.html">Authentication Test</a>
        <a href="/submit.html">Submit Prior Auth</a>
        <a href="/poll.html">Poll Status</a>
        <a href="/convert.html">FHIR-Availity Converter</a>
    </div>

    <h1>FHIR and Availity API Converter</h1>

    <div class="card">
        <p>Convert between FHIR Claim resources and Availity API format. Edit either JSON and click the "Convert" button to convert in the desired direction.</p>

        <div class="container">
            <div class="json-container">
                <div class="json-header">
                    <h2>FHIR</h2>
                    <div class="button-container">
                        <button id="loadSampleFhir">Load Sample</button>
                        <button id="editFhir" class="edit-button">Edit</button>
                        <button id="convertToAvailityJson" class="convert-button">Convert →</button>
                    </div>
                </div>
                <textarea id="fhirJson" class="json-editor" spellcheck="false"></textarea>
                <div id="fhirJsonViewer" class="json-viewer" style="display: none;"></div>
            </div>

            <div class="json-container">
                <div class="json-header">
                    <h2>Availity API</h2>
                    <div class="button-container">
                        <button id="convertToFhirJson" class="convert-button">← Convert</button>
                        <button id="editAvailityJson" class="edit-button">Edit</button>
                        <button id="loadSampleAvailityJson">Load Sample</button>
                    </div>
                </div>
                <textarea id="availityJsonEditor" class="json-editor" spellcheck="false" style="display: none;"></textarea>
                <div id="availityJsonViewer" class="json-viewer"></div>
            </div>
        </div>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        // Sample FHIR Claim JSON
        const sampleFhirJson = {
            "resourceType": "Claim",
            "status": "active",
            "type": {
              "coding": [
                {
                  "system": "http://terminology.hl7.org/CodeSystem/claim-type",
                  "code": "professional"
                }
              ]
            },
            "use": "preauthorization",
            "created": "2022-09-01",
            "provider": {
              "identifier": {
                "system": "http://hl7.org/fhir/sid/us-npi",
                "value": "1234567891"
              },
              "display": "TEST PROVIDERONE"
            },
            "insurer": {
              "identifier": {
                "system": "http://availity.com/payer-id",
                "value": "99999"
              }
            },
            "patient": {
              "identifier": {
                "system": "http://example.org/members",
                "value": "NCF103T99937"
              },
              "display": "TEST PATIENTONE"
            },
            "priority": {
              "coding": [
                {
                  "code": "normal"
                }
              ]
            },
            "diagnosis": [
              {
                "sequence": 1,
                "diagnosisCodeableConcept": {
                  "coding": [
                    {
                      "system": "http://hl7.org/fhir/sid/icd-10",
                      "code": "A52.00"
                    }
                  ]
                }
              }
            ],
            "procedure": [
              {
                "sequence": 1,
                "date": "2022-09-02",
                "procedureCodeableConcept": {
                  "coding": [
                    {
                      "system": "http://www.ama-assn.org/go/cpt",
                      "code": "99242"
                    }
                  ]
                }
              }
            ]
        };

        // Sample Availity Service Review JSON
        const sampleAvailityJson = {
            "serviceReview": {
              "payer": {
                "id": "99999"
              },
              "requestingProvider": {
                "lastName": "PROVIDERONE",
                "firstName": "TEST",
                "npi": "1234567891",
                "taxId": "111111111",
                "addressLine1": "111 HEALTHY PKWY",
                "city": "JACKSONVILLE",
                "stateCode": "FL",
                "zipCode": "22222",
                "phone": "1234567890",
                "contactName": "NURSE LINE",
                "roleCode": "1P"
              },
              "subscriber": {
                "memberId": "NCF103T99937"
              },
              "patient": {
                "firstName": "TEST",
                "lastName": "PATIENTONE",
                "subscriberRelationshipCode": "18",
                "birthDate": "1990-01-01"
              },
              "diagnoses": [
                {
                  "qualifierCode": "ABK",
                  "code": "A52.00"
                }
              ],
              "requestTypeCode": "HS",
              "serviceTypeCode": "73",
              "placeOfServiceCode": "22",
              "serviceLevelCode": "E",
              "fromDate": "2022-09-02",
              "toDate": "2022-09-13",
              "quantity": "1",
              "quantityTypeCode": "VS",
              "procedures": [
                {
                  "fromDate": "2022-09-02",
                  "toDate": "2022-09-13",
                  "code": "99242",
                  "qualifierCode": "HC",
                  "quantity": "1",
                  "quantityTypeCode": "UN"
                }
              ],
              "renderingProviders": [
                {
                  "lastName": "PROVIDERONE",
                  "firstName": "TEST",
                  "npi": "1234567891",
                  "taxId": "111111111",
                  "roleCode": "71",
                  "addressLine1": "111 HEALTHY PKWY",
                  "city": "JACKSONVILLE",
                  "stateCode": "FL",
                  "zipCode": "22222"
                },
                {
                  "lastName": "PROVIDERTWO",
                  "npi": "1234567892",
                  "taxId": "222222222",
                  "roleCode": "FA",
                  "addressLine1": "222 PROCEDURE ROADWAY",
                  "city": "JACKSONVILLE",
                  "stateCode": "FL",
                  "zipCode": "22222"
                }
              ]
            }
        };

        // Format JSON with indentation
        function formatJson(json) {
            try {
                if (typeof json === 'string') {
                    json = JSON.parse(json);
                }
                return JSON.stringify(json, null, 2);
            } catch (e) {
                showStatusMessage('Error formatting JSON: ' + e.message, false);
                return json;
            }
        }

        // Show status message
        function showStatusMessage(message, isSuccess) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';

            if (isSuccess) {
                statusMessage.className = 'status-message success-message';
            } else {
                statusMessage.className = 'status-message error-message';
            }

            // Hide message after 5 seconds
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        // Convert FHIR Claim to Availity API format directly in the browser
        function convertFhirToAvailityJson(fhirJson) {
            return new Promise((resolve, reject) => {
                try {
                    // Parse FHIR JSON if it's a string to validate it
                    const fhirObj = typeof fhirJson === 'string' ? JSON.parse(fhirJson) : fhirJson;

                    // Validate that this is a FHIR Claim
                    if (fhirObj.resourceType !== 'Claim') {
                        throw new Error('Input is not a FHIR Claim resource');
                    }

                    // Create a simple Availity service review object
                    const serviceReview = {
                        // Payer information
                        payer: {
                            id: fhirObj.insurer?.identifier?.value || 'BCBSF',
                            name: fhirObj.insurer?.display || 'FLORIDA BLUE'
                        },

                        // Provider information
                        requestingProvider: {
                            npi: fhirObj.provider?.identifier?.value || '1234567893',
                            lastName: fhirObj.provider?.display?.split(' ')[1] || 'PROVIDER',
                            firstName: fhirObj.provider?.display?.split(' ')[0] || 'TEST',
                            roleCode: '1P',
                            addressLine1: '123 Provider Street',
                            city: 'JACKSONVILLE',
                            stateCode: 'FL',
                            zipCode: '32223',
                            phone: '9043334444',
                            contactName: 'John Doe'
                        },

                        // Subscriber information
                        subscriber: {
                            memberId: fhirObj.patient?.identifier?.value || 'ASBA1274712',
                            firstName: fhirObj.patient?.display?.split(' ')[0] || 'TEST',
                            lastName: fhirObj.patient?.display?.split(' ')[1] || 'PATIENT'
                        },

                        // Patient information
                        patient: {
                            firstName: 'TEST',
                            lastName: 'PATIENTONE',
                            subscriberRelationshipCode: '18',
                            birthDate: '1990-01-01'
                        },

                        // Diagnoses
                        diagnoses: fhirObj.diagnosis?.map(diag => ({
                            qualifierCode: 'ABK',
                            code: diag.diagnosisCodeableConcept?.coding?.[0]?.code || '78900'
                        })) || [{
                            qualifierCode: 'ABK',
                            code: '78900'
                        }],

                        // Request metadata
                        requestTypeCode: 'HS',
                        serviceTypeCode: '73',
                        placeOfServiceCode: '22',
                        serviceLevelCode: 'E',
                        fromDate: '2022-09-02',
                        toDate: '2022-09-13',
                        quantity: '1',
                        quantityTypeCode: 'VS',

                        // Procedures
                        procedures: fhirObj.procedure?.map(proc => ({
                            fromDate: '2022-09-02',
                            toDate: '2022-09-13',
                            code: proc.procedureCodeableConcept?.coding?.[0]?.code || '99213',
                            qualifierCode: 'HC',
                            quantity: '1',
                            quantityTypeCode: 'UN'
                        })) || [{
                            fromDate: '2022-09-02',
                            toDate: '2022-09-13',
                            code: '99213',
                            qualifierCode: 'HC',
                            quantity: '1',
                            quantityTypeCode: 'UN'
                        }],

                        // Rendering Providers
                        renderingProviders: [{
                            lastName: 'PROVIDERONE',
                            firstName: 'TEST',
                            npi: '1234567891',
                            taxId: '111111111',
                            roleCode: '71',
                            addressLine1: '111 HEALTHY PKWY',
                            city: 'JACKSONVILLE',
                            stateCode: 'FL',
                            zipCode: '22222'
                        }]
                    };

                    // Wrap in the expected structure
                    const availityJson = JSON.stringify({ serviceReview }, null, 2);
                    resolve(availityJson);
                } catch (e) {
                    reject(e);
                }
            });
        }

        // Convert Availity API format to FHIR Claim directly in the browser
        function convertAvailityToFhirJson(availityJson) {
            return new Promise((resolve, reject) => {
                try {
                    // Parse Availity JSON if it's a string to validate it
                    const availityObj = typeof availityJson === 'string' ? JSON.parse(availityJson) : availityJson;

                    // Validate that this is an Availity API format
                    if (!availityObj.serviceReview) {
                        throw new Error('Input is not in Availity API format');
                    }

                    const serviceReview = availityObj.serviceReview;

                    // Create a FHIR Claim resource
                    const fhirClaim = {
                        resourceType: 'Claim',
                        id: 'example-claim-' + Math.floor(Math.random() * 10000),
                        status: 'active',
                        use: 'preauthorization',
                        created: new Date().toISOString(),

                        // Patient information
                        patient: {
                            reference: 'Patient/' + (serviceReview.patient?.lastName || 'PATIENT'),
                            display: (serviceReview.patient?.firstName || '') + ' ' + (serviceReview.patient?.lastName || 'PATIENT')
                        },

                        // Provider information
                        provider: {
                            reference: 'Organization/' + (serviceReview.requestingProvider?.npi || '1234567893'),
                            display: serviceReview.requestingProvider?.lastName || 'PROVIDER'
                        },

                        // Insurer information
                        insurer: {
                            reference: 'Organization/' + (serviceReview.payer?.id || 'BCBSF'),
                            display: serviceReview.payer?.name || 'FLORIDA BLUE'
                        },

                        // Diagnoses
                        diagnosis: serviceReview.diagnoses?.map((diag, index) => ({
                            sequence: index + 1,
                            diagnosisCodeableConcept: {
                                coding: [{
                                    system: 'http://hl7.org/fhir/sid/icd-10',
                                    code: diag.code || '78900',
                                    display: 'Diagnosis ' + (index + 1)
                                }]
                            }
                        })) || [],

                        // Procedures
                        procedure: serviceReview.procedures?.map((proc, index) => ({
                            sequence: index + 1,
                            procedureCodeableConcept: {
                                coding: [{
                                    system: 'http://www.ama-assn.org/go/cpt',
                                    code: proc.code || '99213',
                                    display: 'Procedure ' + (index + 1)
                                }]
                            },
                            date: proc.fromDate || '2022-09-02'
                        })) || [],

                        // Insurance
                        insurance: [{
                            sequence: 1,
                            focal: true,
                            coverage: {
                                reference: 'Coverage/' + (serviceReview.subscriber?.memberId || 'ASBA1274712'),
                                display: 'Coverage for ' + (serviceReview.subscriber?.lastName || 'PATIENT')
                            }
                        }],

                        // Item
                        item: serviceReview.procedures?.map((proc, index) => ({
                            sequence: index + 1,
                            productOrService: {
                                coding: [{
                                    system: 'http://www.ama-assn.org/go/cpt',
                                    code: proc.code || '99213',
                                    display: 'Service ' + (index + 1)
                                }]
                            },
                            servicedPeriod: {
                                start: proc.fromDate || '2022-09-02',
                                end: proc.toDate || '2022-09-13'
                            },
                            quantity: {
                                value: parseInt(proc.quantity || '1')
                            }
                        })) || []
                    };

                    // Convert to JSON string
                    const fhirJson = JSON.stringify(fhirClaim, null, 2);
                    resolve(fhirJson);
                } catch (e) {
                    reject(e);
                }
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const fhirJsonTextarea = document.getElementById('fhirJson');
            const fhirJsonViewer = document.getElementById('fhirJsonViewer');
            const availityJsonEditor = document.getElementById('availityJsonEditor');
            const availityJsonViewer = document.getElementById('availityJsonViewer');

            // Function to toggle between edit and view modes
            function toggleEditMode(editorElement, viewerElement, isEditMode) {
                if (isEditMode) {
                    // Switch to edit mode
                    const content = viewerElement.textContent.trim();
                    editorElement.value = content;
                    viewerElement.style.display = 'none';
                    editorElement.style.display = 'block';
                } else {
                    // Switch to view mode
                    try {
                        const json = JSON.parse(editorElement.value);
                        viewerElement.innerHTML = `<pre>${formatJson(json)}</pre>`;
                    } catch (e) {
                        viewerElement.innerHTML = `<pre>${editorElement.value}</pre>`;
                    }
                    editorElement.style.display = 'none';
                    viewerElement.style.display = 'block';
                }
            }

            // Load sample FHIR JSON
            document.getElementById('loadSampleFhir').addEventListener('click', function() {
                fhirJsonTextarea.value = formatJson(sampleFhirJson);
                toggleEditMode(fhirJsonTextarea, fhirJsonViewer, false);
                showStatusMessage('Sample FHIR Claim loaded', true);
            });

            // Load sample Availity JSON
            document.getElementById('loadSampleAvailityJson').addEventListener('click', function() {
                availityJsonEditor.value = formatJson(sampleAvailityJson);
                toggleEditMode(availityJsonEditor, availityJsonViewer, false);
                showStatusMessage('Sample Availity Service Review loaded', true);
            });

            // Toggle FHIR JSON edit mode
            document.getElementById('editFhir').addEventListener('click', function() {
                const isCurrentlyEditing = fhirJsonTextarea.style.display === 'block';
                if (isCurrentlyEditing) {
                    // Switch to view mode
                    toggleEditMode(fhirJsonTextarea, fhirJsonViewer, false);
                    this.textContent = 'Edit';
                } else {
                    // Switch to edit mode
                    toggleEditMode(fhirJsonTextarea, fhirJsonViewer, true);
                    this.textContent = 'View';
                }
            });

            // Toggle Availity JSON edit mode
            document.getElementById('editAvailityJson').addEventListener('click', function() {
                const isCurrentlyEditing = availityJsonEditor.style.display === 'block';
                if (isCurrentlyEditing) {
                    // Switch to view mode
                    toggleEditMode(availityJsonEditor, availityJsonViewer, false);
                    this.textContent = 'Edit';
                } else {
                    // Switch to edit mode
                    toggleEditMode(availityJsonEditor, availityJsonViewer, true);
                    this.textContent = 'View';
                }
            });

            // Convert FHIR to Availity
            document.getElementById('convertToAvailityJson').addEventListener('click', function() {
                try {
                    // Get the FHIR JSON from either the textarea or the viewer
                    let fhirJson;
                    if (fhirJsonTextarea.style.display === 'block') {
                        fhirJson = fhirJsonTextarea.value.trim();
                    } else {
                        fhirJson = fhirJsonViewer.textContent.trim();
                    }

                    if (!fhirJson) {
                        showStatusMessage('Please enter FHIR JSON', false);
                        return;
                    }

                    // Show loading message
                    showStatusMessage('Converting FHIR to Availity...', true);
                    availityJsonViewer.innerHTML = '<div style="text-align: center; padding: 20px;">Converting...</div>';

                    // Call the conversion function
                    convertFhirToAvailityJson(fhirJson)
                        .then(availityJson => {
                            try {
                                // Format the JSON for display
                                const formattedJson = formatJson(availityJson);
                                availityJsonViewer.innerHTML = `<pre>${formattedJson}</pre>`;
                                availityJsonEditor.value = formattedJson;
                                showStatusMessage('Conversion successful', true);
                            } catch (e) {
                                availityJsonViewer.innerHTML = `<pre>${availityJson}</pre>`;
                                availityJsonEditor.value = availityJson;
                                showStatusMessage('Conversion successful, but error formatting JSON', true);
                            }

                            // Make sure we're in view mode
                            availityJsonEditor.style.display = 'none';
                            availityJsonViewer.style.display = 'block';
                            document.getElementById('editAvailityJson').textContent = 'Edit';
                        })
                        .catch(error => {
                            availityJsonViewer.innerHTML = '<div style="color: red; padding: 20px;">Conversion failed</div>';
                            showStatusMessage('Error converting JSON: ' + error.message, false);
                        });
                } catch (e) {
                    showStatusMessage('Error converting JSON: ' + e.message, false);
                }
            });

            // Convert Availity to FHIR
            document.getElementById('convertToFhirJson').addEventListener('click', function() {
                try {
                    // Get the Availity JSON from either the textarea or the viewer
                    let availityJson;
                    if (availityJsonEditor.style.display === 'block') {
                        availityJson = availityJsonEditor.value.trim();
                    } else {
                        availityJson = availityJsonViewer.textContent.trim();
                    }

                    if (!availityJson) {
                        showStatusMessage('Please enter Availity JSON', false);
                        return;
                    }

                    // Show loading message
                    showStatusMessage('Converting Availity to FHIR...', true);
                    fhirJsonViewer.innerHTML = '<div style="text-align: center; padding: 20px;">Converting...</div>';

                    // Call the conversion function
                    convertAvailityToFhirJson(availityJson)
                        .then(fhirJson => {
                            try {
                                // Format the JSON for display
                                const formattedJson = formatJson(fhirJson);
                                fhirJsonViewer.innerHTML = `<pre>${formattedJson}</pre>`;
                                fhirJsonTextarea.value = formattedJson;
                                showStatusMessage('Conversion successful', true);
                            } catch (e) {
                                fhirJsonViewer.innerHTML = `<pre>${fhirJson}</pre>`;
                                fhirJsonTextarea.value = fhirJson;
                                showStatusMessage('Conversion successful, but error formatting JSON', true);
                            }

                            // Make sure we're in view mode
                            fhirJsonTextarea.style.display = 'none';
                            fhirJsonViewer.style.display = 'block';
                            document.getElementById('editFhir').textContent = 'Edit';
                        })
                        .catch(error => {
                            fhirJsonViewer.innerHTML = '<div style="color: red; padding: 20px;">Conversion failed</div>';
                            showStatusMessage('Error converting JSON: ' + error.message, false);
                        });
                } catch (e) {
                    showStatusMessage('Error converting JSON: ' + e.message, false);
                }
            });

            // Load sample data on page load
            fhirJsonTextarea.value = formatJson(sampleFhirJson);
            availityJsonViewer.innerHTML = `<pre>${formatJson(sampleAvailityJson)}</pre>`;
            availityJsonEditor.value = formatJson(sampleAvailityJson);
        });
    </script>
</body>
</html>
